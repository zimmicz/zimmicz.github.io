<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
        <title>Michal Zimmermann | tag: javascript</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">
        <link href="https://www.zimmi.cz/posts/atom.xml" type="application/atom+xml" rel="alternate" title="Michal Zimmermann Full Atom Feed" />
        <link href="https://www.zimmi.cz/posts/feed.xml" type="application/rss+xml" rel="alternate" title="Michal Zimmermann Full RSS Feed" />
        <link rel="stylesheet" href="https://www.zimmi.cz/posts/theme/css/style.min.css?1ec62741">
</head>
<body>
    <nav role="navigation">
        <ul>
            <li><a href="https://www.zimmi.cz/posts/categories">Categories</a></li>
            <li><a href="https://www.zimmi.cz/posts/tags">Tags</a></li>
            <li><a href="https://www.zimmi.cz/posts/feed.xml">Subscribe to RSS feed</a></li>
        </ul>
    </nav>
    <header>
        <h1><a href="/posts">Michal Zimmermann<small>Pieces of knowledge from the world of GIS.</small></a></h1>
    </header>
    <main>
<h2 class="text-center">Articles tagged with javascript tag</h2>

<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/postgis-as-a-mapbox-vector-tiles-generator/" rel="bookmark" title="Permalink to PostGIS as a Mapbox Vector Tiles generator">PostGIS as a Mapbox Vector Tiles&nbsp;generator</a></h1>
    <aside><span>Aug 6, 2017</span>
    <span>    <a href="https://www.zimmi.cz/posts/tag/docker.html">docker</a>     <a href="https://www.zimmi.cz/posts/tag/postgis.html">postgis</a>     <a href="https://www.zimmi.cz/posts/tag/javascript.html">javascript</a>    </span>
    <span><a href="https://www.zimmi.cz/posts/category/sql.html">SQL</a></span>
    </aside>
    <p><a href="http://postgis.net/2017/08/05/postgis-2.4.0alpha/">PostGIS 2.4.0</a> was released recently bringing the possibilities to generate <strong>Mapbox Vector Tiles</strong> without any third party tools. I got a shot at it with Node.js and docker. Even if it&#8217;s not as straightforward as solely using <a href="https://postgis.net/docs/manual-dev/ST_AsMVT.html">ST_AsMVT</a>, it still looks pretty&nbsp;great.</p>
<h2>Docker&nbsp;container</h2>
<p>There are no Ubuntu or Debian based PostGIS 2.4.0 packages as far as I know. As installation from source (especially considering <span class="caps">GIS</span> software) is always a bit risky, I prefer using Docker to stay away from trouble. The image is based on Ubuntu 17.04, has PostgreSQL 9.6 and PostGIS 2.4.0 installed. It exposes port 5432 to the host, so you can access the database from the outside the&nbsp;container.</p>
<div class="highlight"><pre><span></span>FROM ubuntu:17.04
RUN apt update
RUN apt install -y wget less systemd
RUN touch /etc/apt/sources.list.d/pgdg.list
RUN <span class="nb">echo</span> <span class="s2">&quot;deb http://apt.postgresql.org/pub/repos/apt/ zesty-pgdg main&quot;</span> &gt; /etc/apt/sources.list.d/pgdg.list
RUN wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc <span class="p">|</span> apt-key add -
RUN apt update
RUN apt -y install postgresql-9.6 postgresql-server-dev-9.6

USER postgres
RUN /usr/lib/postgresql/9.6/bin/pg_ctl -D /var/lib/postgresql/9.6/main -l /tmp/logfile start

USER root
RUN <span class="nb">echo</span> <span class="s2">&quot;host all  all    0.0.0.0/0  trust&quot;</span> &gt;&gt; /etc/postgresql/9.6/main/pg_hba.conf <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">echo</span> <span class="s2">&quot;listen_addresses=&#39;*&#39;&quot;</span> &gt;&gt; /etc/postgresql/9.6/main/postgresql.conf


EXPOSE <span class="m">5432</span>
RUN apt install -y netcat build-essential libxml2 libxml2-dev libgeos-3.5.1 libgdal-dev gdal-bin libgdal20 libgeos-dev libprotobuf-c1 libprotobuf-c-dev libprotobuf-dev protobuf-compiler protobuf-c-compiler
RUN wget http://download.osgeo.org/postgis/source/postgis-2.4.0alpha.tar.gz
RUN tar -xvzf postgis-2.4.0alpha.tar.gz
RUN <span class="nb">cd</span> postgis-2.4.0alpha <span class="o">&amp;&amp;</span> ./configure <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make install

USER postgres
RUN service postgresql start <span class="o">&amp;&amp;</span> psql -c <span class="s2">&quot;CREATE EXTENSION postgis&quot;</span>

USER root
COPY start.postgis.sh /start.postgis.sh
RUN chmod <span class="m">0755</span> /start.postgis.sh

CMD <span class="o">[</span><span class="s2">&quot;/start.postgis.sh&quot;</span><span class="o">]</span>
</pre></div>


<p><code>start.postgis.sh</code> file starts the database server and keeps it running&nbsp;forever.</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">DATADIR</span><span class="o">=</span><span class="s2">&quot;/var/lib/postgresql/9.6/main&quot;</span>
<span class="nv">CONF</span><span class="o">=</span><span class="s2">&quot;/etc/postgresql/9.6/main/postgresql.conf&quot;</span>
<span class="nv">POSTGRES</span><span class="o">=</span><span class="s2">&quot;/usr/lib/postgresql/9.6/bin/postgres&quot;</span>

su postgres sh -c <span class="s2">&quot;</span><span class="nv">$POSTGRES</span><span class="s2"> -D </span><span class="nv">$DATADIR</span><span class="s2"> -c config_file=</span><span class="nv">$CONF</span><span class="s2">&quot;</span> <span class="p">&amp;</span>
<span class="k">until</span> nc -z localhost <span class="m">5432</span><span class="p">;</span>
<span class="k">do</span>
    <span class="nb">echo</span> ...
    sleep <span class="m">5</span>
<span class="k">done</span>
sleep <span class="m">5</span> <span class="c1"># just for sure</span>
su - postgres -c <span class="s2">&quot;psql -c \&quot;CREATE EXTENSION IF NOT EXISTS postgis\&quot;&quot;</span>
<span class="nb">echo</span> database up and running

<span class="nb">wait</span> <span class="nv">$!</span>
</pre></div>


<h2>Data</h2>
<p>I got a cadastre area dataset of the Czech Republic for testing, which contains ~ 13,000 polygons. The geometries should come in Web Mercator a.k.a. <span class="caps">EPSG</span>:3857 to work with <a href="https://www.mapbox.com/vector-tiles/specification/"><span class="caps">MVT</span></a>.</p>
<h2>Vector&nbsp;tiles</h2>
<p>I got a bit confused by the docs of <a href="https://postgis.net/docs/manual-dev/ST_AsMVT.html">ST_AsMVT</a> and <a href="https://postgis.net/docs/manual-dev/ST_AsMVTGeom.html">ST_AsMVTGeom</a>. Especially the latter one took me a few hours to get it right. What is essential (I guess) about Mapbox Vector Tiles is that you have to abstract from the real world coordinates and start thinking inside the tile coordinates. What PostGIS does with <code>ST_AsMVTGeom</code> (and what any other <span class="caps">MVT</span> implemenation should do for you) is that it takes real world coordinates and put them inside a&nbsp;tile.</p>
<div class="text-center"><img src="https://www.zimmi.cz/posts/assets/postgis-as-a-mapbox-vector-tiles-generator/mvt.gif"/></div>

<p>To make this work, you need to know every bounding box of every tile on every zoom level in a Web Mercator projection. Or you can use <a href="https://github.com/mapbox/postgis-vt-util/blob/master/src/TileBBox.sql">TileBBox procedure by Mapbox</a>, if you&nbsp;wish.</p>
<p>The <span class="caps">SQL</span> query itself is pretty simple (this comes from an express route I&#8217;ll be discussing&nbsp;shortly).</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_AsMVT</span><span class="p">(</span><span class="s1">&#39;cadastre&#39;</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
<span class="k">FROM</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">code</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">ST_AsMVTGeom</span><span class="p">(</span>
            <span class="n">geom</span><span class="p">,</span>
            <span class="n">TileBBox</span><span class="p">(</span><span class="err">${</span><span class="n">req</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">z</span><span class="err">}</span><span class="p">,</span> <span class="err">${</span><span class="n">req</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">x</span><span class="err">}</span><span class="p">,</span> <span class="err">${</span><span class="n">req</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">y</span><span class="err">}</span><span class="p">,</span> <span class="mi">3857</span><span class="p">),</span>
            <span class="mi">4096</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="k">false</span>
        <span class="p">)</span> <span class="n">geom</span>
    <span class="k">FROM</span> <span class="n">cadastre_area</span>
    <span class="k">WHERE</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">ST_Transform</span><span class="p">(</span><span class="n">ST_MakeEnvelope</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="err">$</span><span class="mi">3</span><span class="p">,</span> <span class="err">$</span><span class="mi">4</span><span class="p">,</span> <span class="err">$</span><span class="mi">5</span><span class="p">),</span> <span class="mi">3857</span><span class="p">)))</span>
<span class="p">)</span> <span class="n">q</span>
</pre></div>


<p>When filled with proper arguments instead of placeholders, it returns a&nbsp;bytea.</p>
<div class="highlight"><pre><span></span><span class="se">\x</span>1aa5dbd0070a047465737412e216120400000101180322d7160987913f8db38e01aa59160e2a010412012a0624060e001410420a1a00203b0a3914190e15085912010a0f0c0f06370804080a0e0e0234090e0
</pre></div>


<p>This can be consumed by a Leaflet map using <a href="https://github.com/Leaflet/Leaflet.VectorGrid">Leaflet.VectorGrid plugin</a>. To keep it short, the frontend code actually boils down to three lines of&nbsp;code.</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:3000/mvt/{x}/{y}/{z}&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">cadastre</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">vectorGrid</span><span class="p">.</span><span class="nx">protobuf</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">cadastre</span><span class="p">);</span>
</pre></div>


<p>The <a href="https://gist.github.com/zimmicz/9e78d9888ab73abc7e87553b77999bc8">server <span class="caps">MVP</span> is available</a> as a GitHub&nbsp;gist.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2016/plotting-the-czech-cadastre-land-use-with-d3-data-viz-part-iv/" rel="bookmark" title="Permalink to Plotting the Czech Cadastre Land Use with d3: Data Viz (part IV)">Plotting the Czech Cadastre Land Use with d3: Data Viz (part <span class="caps">IV</span>)</a></h1>
    <aside><span>Nov 20, 2016</span>
    <span>    <a href="https://www.zimmi.cz/posts/tag/d3.html">d3</a>     <a href="https://www.zimmi.cz/posts/tag/javascript.html">javascript</a>     <a href="https://www.zimmi.cz/posts/tag/svg.html">svg</a>    </span>
    <span><a href="https://www.zimmi.cz/posts/category/data.html">data</a></span>
    </aside>
    <p>This post is the fourth part of the series summarizing the process of visualizing land use data with bash, PostgreSQL and d3.js. Read other&nbsp;parts:</p>
<ol>
<li><a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-extraction-part-i">Plotting the Czech Cadastre Land Use with d3: Data Extraction (part&nbsp;I)</a></li>
<li><a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-transformation-part-ii">Plotting the Czech Cadastre Land Use with d3: Data Transformation (part <span class="caps">II</span>)</a></li>
<li><a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-load-part-iii/">Plotting the Czech Cadastre Land Use with d3: Data Load (part <span class="caps">III</span>)</a></li>
</ol>
<h2>Data&nbsp;vizualization</h2>
<p>Those of you who&#8217;ve been following this series know all the data are set and ready to be used. The rest of you, <em>shame on you by the way</em>, can go through the above posts to catch&nbsp;up.</p>
<p>The result is available at <a href="https://www.zimmi.cz/kn-landuse-monitor">https://www.zimmi.cz/kn-landuse-monitor</a> and works like the gif&nbsp;below.</p>
<div class="text-center"><img src="https://www.zimmi.cz/posts/assets/plotting-the-czech-cadastre-land-use-with-d3-part-iv/screen.gif" /></div>

<h3>Features</h3>
<ul>
<li>land use data for 13,093 cadastral areas between 2015/01/01 and&nbsp;2016/10/01</li>
<li>relative area and parcel count per land use&nbsp;type</li>
<li>similar cadastres based on land use relative area&nbsp;values</li>
<li>time series plots for various charachteristics (including agricultural land area and parcel&nbsp;count)</li>
</ul>
<h3>Todos</h3>
<ul>
<li>time series chart titles&nbsp;onmouseover</li>
<li>barchart titles&nbsp;onmouseover</li>
<li>absolute values chart&nbsp;(?)</li>
<li><code>fetch API</code> polyfill</li>
<li>Firefox seems to be&nbsp;broken</li>
</ul>
<h3>Technologies</h3>
<p>I implemented <a href="https://github.com/zimmicz/kn-landuse-monitor/tree/f0af50d44d6aac11adb6cdb0c7c67a97d7db1df3">the whole app with vanilla JavaScript</a>. The app resided in the <code>Monitor</code> variable, had several modules that were communicating via custom events with each&nbsp;other.</p>
<p>So far, so good. Once the app was production-ready, I stumbled upon <a href="https://vuejs.org">vue.js</a>, which is by miles the best JavaScript framework experience I&#8217;ve had so far. Reinventing the app once again was the matter of two days (thanks to <a href="https://github.com/vuejs-templates/webpack">this amazing setup</a> - hot reload&nbsp;included).</p>
<p>Thus, the current version of the app is based&nbsp;on:</p>
<h4>vue.js</h4>
<p>Thanks to the easy-to-understand system of components, properties and methods, learning curve is really steep. The app is now divided into several components (Search, Dashboard with child components for charts and similar cadastres&nbsp;list).</p>
<h4>vuex</h4>
<p><a href="https://vuex.vuejs.org/en/">Vuex</a>, probably inspired by Flux or Redux, is the <em>&#8220;state management pattern + library&#8221;</em>, the single source of truth for your apps. That&#8217;s pretty much it: there&#8217;s only one place in your app (called the <code>store</code>), where you go to put or get your data. Not necessarily every single piece of data, just those pieces used across several components. It plays really nice with the&nbsp;vue.js.</p>
<h4>D3.js</h4>
<p>Tried it before, <a href="https://d3js.org">D3.js</a> was really hard to grasp. And it still is, I guess. At the same time, it&#8217;s damn good at plotting the data. Yet, being a bit less low-level would be&nbsp;great.</p>
<h4>Dexie</h4>
<p>I hate writing servers for my pet projects. The server means no Github Pages. Thus, I decided to load the whole dataset with <code>fetch API</code>  from the external <span class="caps">JSON</span> file. Loading the 13K objects &times; 30 properties &times; array with 8 items in each didn&#8217;t seem like the best idea ever, so&hellip; Here comes <a href="http://dexie.org">Dexie</a>, a <code>IndexedDB API</code> wrapper that makes it easy on you (unlike the <code>IndexedDB API</code> itself, which doesn&#8217;t even let you find out whether the database you&#8217;re creating already exists.&nbsp;Seriously?).</p>
<p>Dexie loads the initial dataset into the IndexedDB storage and reads it every time user comes back without loading the <span class="caps">JSON</span> file again. On data change, the fresh file will be loaded, the database flushed and the new data written. <a href="https://github.com/zimmicz/kn-landuse-monitor/blob/master/src/stores/actions.js">Behold</a>; I hate the way it&#8217;s&nbsp;written.</p>
<h4>Flex</h4>
<p>Used <code>flex</code> for the first time, I&#8217;m not sure I understand how it actually works though. <span class="caps">CSS</span> feels more complicated every time I need&nbsp;it.</p>
<p><small>Bottom line: I use localStorage to keep track of the database existence.</small></p>
<h3>Resume</h3>
<p>Two pet projects completed in one month definitely means the winter is here! Looking forward to using more&nbsp;vue.js.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-load-part-iii/" rel="bookmark" title="Permalink to Plotting the Czech Cadastre Land Use with d3: Data Load (part III)">Plotting the Czech Cadastre Land Use with d3: Data Load (part <span class="caps">III</span>)</a></h1>
    <aside><span>Nov 15, 2016</span>
    <span>    <a href="https://www.zimmi.cz/posts/tag/postgresql.html">postgresql</a>     <a href="https://www.zimmi.cz/posts/tag/d3.html">d3</a>     <a href="https://www.zimmi.cz/posts/tag/javascript.html">javascript</a>     <a href="https://www.zimmi.cz/posts/tag/svg.html">svg</a>    </span>
    <span><a href="https://www.zimmi.cz/posts/category/data.html">data</a></span>
    </aside>
    <p>This post is the third part of the series summarizing the process of visualizing landuse data with bash, PostgreSQL and d3.js. Read other&nbsp;parts:</p>
<ol>
<li><a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-extraction-part-i">Plotting the Czech Cadastre Land Use with d3: Data Extraction (part&nbsp;I)</a></li>
<li><a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-transformation-part-ii">Plotting the Czech Cadastre Land Use with d3: Data Transformation (part <span class="caps">II</span>)</a></li>
<li>you&#8217;re reading it&nbsp;now</li>
</ol>
<h2><span class="caps">ETL</span>&nbsp;process</h2>
<p>Before the d3 viz can be crafted, it&#8217;s necessary&nbsp;to:</p>
<ol>
<li>extract <span class="caps">CSV</span> data from the URLs provided via the Atom&nbsp;feed</li>
<li>transform those data into a relational database, do some&nbsp;math</li>
<li>load data into a d3.js&nbsp;viz</li>
<li>profit (as&nbsp;usual)</li>
</ol>
<h3>Extract</h3>
<p>See <a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-extraction-part-i">Plotting the Czech Cadastre Land Use with d3: Data Extraction (part I)</a>.</p>
<h3>Transform</h3>
<p>See <a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-transformation-part-ii">Plotting the Czech Cadastre Land Use with d3: Data Transformation (part <span class="caps">II</span>)</a>.</p>
<h2>Load</h2>
<p>Thanks to the way I transformed the data, the whole load is done with&nbsp;simple</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

touch ./data/data.js
<span class="nb">echo</span> <span class="s2">&quot;let data =&quot;</span> &gt; ./data/data.js

<span class="o">(</span>
cat <span class="s">&lt;&lt; EOF | psql -qAt --no-psqlrc</span>
<span class="s">    SELECT</span>
<span class="s">    array_to_json(array_agg(row_to_json(r)))</span>
<span class="s">    FROM (</span>
<span class="s">    SELECT *</span>
<span class="s">    FROM data</span>
<span class="s">    ) r</span>
<span class="s">EOF</span>
<span class="o">)</span> &gt;&gt; ./data/data.js
</pre></div>


<p>That&#8217;s the whole <span class="caps">ETL</span> process! Next time, I&#8217;ll cover the d3.js&nbsp;viz.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-transformation-part-ii" rel="bookmark" title="Permalink to Plotting the Czech Cadastre Land Use with d3: Data Transformation (part II)">Plotting the Czech Cadastre Land Use with d3: Data Transformation (part <span class="caps">II</span>)</a></h1>
    <aside><span>Nov 14, 2016</span>
    <span>    <a href="https://www.zimmi.cz/posts/tag/javascript.html">javascript</a>     <a href="https://www.zimmi.cz/posts/tag/d3.html">d3</a>     <a href="https://www.zimmi.cz/posts/tag/postgresql.html">postgresql</a>     <a href="https://www.zimmi.cz/posts/tag/svg.html">svg</a>    </span>
    <span><a href="https://www.zimmi.cz/posts/category/data.html">data</a></span>
    </aside>
    <p>This post is the second part of the series summarizing the process of visualizing landuse data with bash, PostgreSQL and d3.js. Read other&nbsp;parts:</p>
<ol>
<li><a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-extraction-part-i">Plotting the Czech Cadastre Land Use with d3: Data Extraction (part&nbsp;I)</a></li>
<li>you&#8217;re reading it&nbsp;now</li>
<li><a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-load-part-iii/">Plotting the Czech Cadastre Land Use with d3: Data Transformation (part <span class="caps">III</span>)</a></li>
</ol>
<h2><span class="caps">ETL</span>&nbsp;process</h2>
<p>Before the d3 viz can be crafted, it&#8217;s necessary&nbsp;to:</p>
<ol>
<li>extract <span class="caps">CSV</span> data from the URLs provided via the Atom&nbsp;feed</li>
<li>transform those data into a relational database, do some&nbsp;math</li>
<li>load data into a d3.js&nbsp;viz</li>
<li>profit (as&nbsp;usual)</li>
</ol>
<h3>Extract</h3>
<p>See <a href="{filename}../2016/plotting-czech-cadastre-landuse-with-d3-part-i.md">Plotting the Czech Cadastre Land Use with d3: Data Extraction (part I)</a>.</p>
<h3>Transform</h3>
<p>Last time, I extracted the data from multiple <span class="caps">CSV</span> files to separate PostgreSQL tables named by <code>data_YYYYMMDD</code> pattern. My current goal is to transform it into the one big <code>data</code> table, where each row represents one cadastral area. Here&#8217;s what I&#8217;m trying to&nbsp;achieve:</p>
<div class="highlight"><pre><span></span>-<span class="o">[</span> RECORD <span class="m">1</span> <span class="o">]</span>----------+----------------------------------
ku_kod                 <span class="p">|</span> <span class="m">600881</span>
ku_nazev               <span class="p">|</span> Bantice
celkova_vymera         <span class="p">|</span> <span class="o">{</span><span class="m">3763255</span>,3763255,3763256,3763256<span class="o">}</span>
celkovy_pocet_parcel   <span class="p">|</span> <span class="o">{</span><span class="m">670</span>,668,664,667<span class="o">}</span>
chmelnice_pp           <span class="p">|</span> <span class="o">{</span><span class="m">0</span>,0,0,0<span class="o">}</span>
chmelnice_pp_r         <span class="p">|</span> <span class="o">{</span><span class="m">0</span>.00,0.00,0.00,0.00<span class="o">}</span>
chmelnice_v            <span class="p">|</span> <span class="o">{</span><span class="m">0</span>,0,0,0<span class="o">}</span>
chmelnice_v_avg        <span class="p">|</span> <span class="o">{</span><span class="m">0</span>,0,0,0<span class="o">}</span>
chmelnice_v_r          <span class="p">|</span> <span class="o">{</span><span class="m">0</span>.00,0.00,0.00,0.00<span class="o">}</span>
lesni_pozemek_pp       <span class="p">|</span> <span class="o">{</span><span class="m">25</span>,25,25,25<span class="o">}</span>
lesni_pozemek_pp_r     <span class="p">|</span> <span class="o">{</span><span class="m">3</span>.73,3.74,3.77,3.75<span class="o">}</span>
lesni_pozemek_v        <span class="p">|</span> <span class="o">{</span><span class="m">83879</span>,83879,83879,83879<span class="o">}</span>
lesni_pozemek_v_avg    <span class="p">|</span> <span class="o">{</span><span class="m">3355</span>,3355,3355,3355<span class="o">}</span>
lesni_pozemek_v_r      <span class="p">|</span> <span class="o">{</span><span class="m">2</span>.23,2.23,2.23,2.23<span class="o">}</span>
orna_puda_pp           <span class="p">|</span> <span class="o">{</span><span class="m">88</span>,88,89,89<span class="o">}</span>
orna_puda_pp_r         <span class="p">|</span> <span class="o">{</span><span class="m">13</span>.13,13.17,13.40,13.34<span class="o">}</span>
orna_puda_v            <span class="p">|</span> <span class="o">{</span><span class="m">3066230</span>,3066230,3066230,3066230<span class="o">}</span>
orna_puda_v_avg        <span class="p">|</span> <span class="o">{</span><span class="m">34844</span>,34844,34452,34452<span class="o">}</span>
orna_puda_v_r          <span class="p">|</span> <span class="o">{</span><span class="m">81</span>.48,81.48,81.48,81.48<span class="o">}</span>
ostatni_plocha_pp      <span class="p">|</span> <span class="o">{</span><span class="m">201</span>,199,199,201<span class="o">}</span>
ostatni_plocha_pp_r    <span class="p">|</span> <span class="o">{</span><span class="m">30</span>.00,29.79,29.97,30.13<span class="o">}</span>
ostatni_plocha_v       <span class="p">|</span> <span class="o">{</span><span class="m">283468</span>,283468,283468,284562<span class="o">}</span>
ostatni_plocha_v_avg   <span class="p">|</span> <span class="o">{</span><span class="m">1410</span>,1424,1424,1416<span class="o">}</span>
ostatni_plocha_v_r     <span class="p">|</span> <span class="o">{</span><span class="m">7</span>.53,7.53,7.53,7.56<span class="o">}</span>
ovocny_sad_pp          <span class="p">|</span> <span class="o">{</span><span class="m">0</span>,0,0,0<span class="o">}</span>
ovocny_sad_pp_r        <span class="p">|</span> <span class="o">{</span><span class="m">0</span>.00,0.00,0.00,0.00<span class="o">}</span>
ovocny_sad_v           <span class="p">|</span> <span class="o">{</span><span class="m">0</span>,0,0,0<span class="o">}</span>
ovocny_sad_v_avg       <span class="p">|</span> <span class="o">{</span><span class="m">0</span>,0,0,0<span class="o">}</span>
ovocny_sad_v_r         <span class="p">|</span> <span class="o">{</span><span class="m">0</span>.00,0.00,0.00,0.00<span class="o">}</span>
ttp_pp                 <span class="p">|</span> <span class="o">{</span><span class="m">44</span>,44,44,45<span class="o">}</span>
ttp_pp_r               <span class="p">|</span> <span class="o">{</span><span class="m">6</span>.57,6.59,6.63,6.75<span class="o">}</span>
ttp_v                  <span class="p">|</span> <span class="o">{</span><span class="m">49002</span>,49002,49002,47908<span class="o">}</span>
ttp_v_avg              <span class="p">|</span> <span class="o">{</span><span class="m">1114</span>,1114,1114,1065<span class="o">}</span>
ttp_v_r                <span class="p">|</span> <span class="o">{</span><span class="m">1</span>.30,1.30,1.30,1.27<span class="o">}</span>
vinice_pp              <span class="p">|</span> <span class="o">{</span><span class="m">1</span>,1,1,1<span class="o">}</span>
vinice_pp_r            <span class="p">|</span> <span class="o">{</span><span class="m">0</span>.15,0.15,0.15,0.15<span class="o">}</span>
vinice_v               <span class="p">|</span> <span class="o">{</span><span class="m">106178</span>,106178,106178,106178<span class="o">}</span>
vinice_v_avg           <span class="p">|</span> <span class="o">{</span><span class="m">106178</span>,106178,106178,106178<span class="o">}</span>
vinice_v_r             <span class="p">|</span> <span class="o">{</span><span class="m">2</span>.82,2.82,2.82,2.82<span class="o">}</span>
vodni_plocha_pp        <span class="p">|</span> <span class="o">{</span><span class="m">23</span>,23,23,23<span class="o">}</span>
vodni_plocha_pp_r      <span class="p">|</span> <span class="o">{</span><span class="m">3</span>.43,3.44,3.46,3.45<span class="o">}</span>
vodni_plocha_v         <span class="p">|</span> <span class="o">{</span><span class="m">27877</span>,27877,27877,27877<span class="o">}</span>
vodni_plocha_v_avg     <span class="p">|</span> <span class="o">{</span><span class="m">1212</span>,1212,1212,1212<span class="o">}</span>
vodni_plocha_v_r       <span class="p">|</span> <span class="o">{</span><span class="m">0</span>.74,0.74,0.74,0.74<span class="o">}</span>
zahrada_pp             <span class="p">|</span> <span class="o">{</span><span class="m">115</span>,115,115,115<span class="o">}</span>
zahrada_pp_r           <span class="p">|</span> <span class="o">{</span><span class="m">17</span>.16,17.22,17.32,17.24<span class="o">}</span>
zahrada_v              <span class="p">|</span> <span class="o">{</span><span class="m">77381</span>,77381,77353,77353<span class="o">}</span>
zahrada_v_avg          <span class="p">|</span> <span class="o">{</span><span class="m">673</span>,673,673,673<span class="o">}</span>
zahrada_v_r            <span class="p">|</span> <span class="o">{</span><span class="m">2</span>.06,2.06,2.06,2.06<span class="o">}</span>
zastavena_plocha_pp    <span class="p">|</span> <span class="o">{</span><span class="m">173</span>,173,168,168<span class="o">}</span>
zastavena_plocha_pp_r  <span class="p">|</span> <span class="o">{</span><span class="m">25</span>.82,25.90,25.30,25.19<span class="o">}</span>
zastavena_plocha_v     <span class="p">|</span> <span class="o">{</span><span class="m">69240</span>,69240,69269,69269<span class="o">}</span>
zastavena_plocha_v_avg <span class="p">|</span> <span class="o">{</span><span class="m">400</span>,400,412,412<span class="o">}</span>
zastavena_plocha_v_r   <span class="p">|</span> <span class="o">{</span><span class="m">1</span>.84,1.84,1.84,1.84<span class="o">}</span>
</pre></div>


<p>Several stats were calculated for each land use category (vinice &rarr; vineyard, ovocny_sad &rarr; orchard,&nbsp;&#8230;):</p>
<ul>
<li><code>v_r</code> suffix stands for land use area&nbsp;ratio</li>
<li><code>pp_r</code> suffix stands for land use parcel count&nbsp;ratio</li>
<li><code>v_avg</code> stands for average parcel&nbsp;area</li>
</ul>
<p>All statistical columns are kept as PostgreSQL <code>ARRAY</code>s, ordered by dates (very handy for the future d3.js viz by the&nbsp;way).</p>
<blockquote>
<p>Note that since the <code>FULL OUTER JOIN</code> is needed in the next step, SQLite can&#8217;t be used. Pity&nbsp;though.</p>
</blockquote>
<p>The whole transformation bash script is the&nbsp;plain:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

psql -qAt --no-psqlrc -f transform.sql <span class="p">|</span> psql -qAt --no-psqlrc
</pre></div>


<p>The <code>transform.sql</code> file is used to build the dynamic <span class="caps">SQL</span> query, which - once built - is piped to another <code>psql</code> command. I admit, pipes are super&nbsp;awesome.</p>
<div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">tables</span> <span class="k">AS</span> <span class="p">(</span>
<span class="c1">-- FULL OUTER JOIN all the data_YYYYMMDD tables</span>
<span class="k">SELECT</span>
    <span class="k">table_name</span><span class="p">,</span>
    <span class="n">table_schema</span><span class="p">,</span>
    <span class="s1">&#39;d&#39;</span> <span class="o">||</span> <span class="n">id</span> <span class="n">tbl</span><span class="p">,</span>
    <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">THEN</span> <span class="n">table_schema</span> <span class="o">||</span> <span class="s1">&#39;.&#39;</span> <span class="o">||</span> <span class="k">table_name</span> <span class="o">||</span> <span class="s1">&#39; d&#39;</span> <span class="o">||</span> <span class="n">id</span>
        <span class="k">ELSE</span> <span class="s1">&#39;FULL OUTER JOIN &#39;</span> <span class="o">||</span> <span class="n">table_schema</span> <span class="o">||</span> <span class="s1">&#39;.&#39;</span> <span class="o">||</span> <span class="k">table_name</span> <span class="o">||</span> <span class="s1">&#39; d&#39;</span> <span class="o">||</span> <span class="n">id</span> <span class="o">||</span> <span class="s1">&#39; ON (d1.ku_kod = d&#39;</span> <span class="o">||</span> <span class="n">id</span> <span class="o">||</span> <span class="s1">&#39;.ku_kod)&#39;</span>
    <span class="k">END</span> <span class="n">tbl_join</span>
<span class="k">FROM</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="k">table_name</span><span class="p">,</span>
        <span class="n">table_schema</span><span class="p">,</span>
        <span class="n">row_number</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="k">table_name</span><span class="p">)</span> <span class="n">id</span>
    <span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span>
    <span class="k">WHERE</span> <span class="k">table_name</span> <span class="k">LIKE</span> <span class="s1">&#39;data_%&#39;</span>
        <span class="k">AND</span> <span class="n">table_type</span> <span class="o">=</span> <span class="s1">&#39;BASE TABLE&#39;</span>
        <span class="k">AND</span> <span class="n">table_schema</span> <span class="o">=</span> <span class="s1">&#39;public&#39;</span>
<span class="p">)</span> <span class="n">a</span>
<span class="p">)</span>
<span class="c1">-- create data table with the correct values order for each statistical column</span>
<span class="c1">-- note that the whole process would crash if d1.ku_kod would be NULL -&gt; @todo fix me</span>
<span class="k">SELECT</span> <span class="s1">&#39;DROP TABLE IF EXISTS data;</span>
<span class="s1">    CREATE TABLE data AS</span>
<span class="s1">    SELECT d1.ku_kod, d1.ku_nazev,&#39;</span>
<span class="k">UNION</span> <span class="k">ALL</span>
<span class="k">SELECT</span>
    <span class="n">array_to_string</span><span class="p">(</span><span class="n">array_agg</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="n">r</span>
<span class="k">FROM</span> <span class="p">(</span>
    <span class="k">SELECT</span>
    <span class="s1">&#39;ARRAY[&#39;</span> <span class="o">||</span> <span class="n">array_to_string</span><span class="p">(</span><span class="n">array_agg</span><span class="p">(</span><span class="n">tables</span><span class="p">.</span><span class="n">tbl</span> <span class="o">||</span> <span class="s1">&#39;.&#39;</span> <span class="o">||</span> <span class="n">columns</span><span class="p">.</span><span class="k">column_name</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">tables</span><span class="p">.</span><span class="k">table_name</span><span class="p">),</span> <span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;]&#39;</span> <span class="o">||</span> <span class="s1">&#39; &#39;</span> <span class="o">||</span> <span class="n">columns</span><span class="p">.</span><span class="k">column_name</span> <span class="n">r</span>
    <span class="k">FROM</span> <span class="n">tables</span>
    <span class="k">JOIN</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">table_schema</span><span class="p">,</span>
        <span class="k">table_name</span><span class="p">,</span>
        <span class="k">column_name</span>
    <span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span>
    <span class="k">WHERE</span> <span class="k">column_name</span> <span class="k">NOT</span> <span class="k">LIKE</span> <span class="s1">&#39;ku_%&#39;</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">ordinal_position</span>
    <span class="p">)</span> <span class="n">columns</span>
    <span class="k">ON</span> <span class="p">(</span><span class="n">tables</span><span class="p">.</span><span class="k">table_name</span> <span class="o">=</span> <span class="n">columns</span><span class="p">.</span><span class="k">table_name</span> <span class="k">AND</span> <span class="n">columns</span><span class="p">.</span><span class="n">table_schema</span> <span class="o">=</span> <span class="n">tables</span><span class="p">.</span><span class="n">table_schema</span><span class="p">)</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">columns</span><span class="p">.</span><span class="k">column_name</span>
<span class="p">)</span> <span class="n">a</span>
<span class="k">UNION</span> <span class="k">ALL</span>
<span class="k">SELECT</span> <span class="s1">&#39;FROM&#39;</span>
<span class="k">UNION</span> <span class="k">ALL</span>
<span class="k">SELECT</span> <span class="n">tbl_join</span> <span class="k">FROM</span> <span class="n">tables</span><span class="p">;</span>
</pre></div>


<p><code>psql -qAt --no-psqlrc -f transform.sql</code> builds the actual query from the query above, <code>| psql -qAt --no-psqlrc</code> sends it to the database again. This part was really fun to&nbsp;implement!</p>
<p>I&#8217;m still considering to store diff values instead of absolute values in those <code>ARRAY</code>s - that would save some serious&nbsp;bandwidth!</p>
<h2>Load</h2>
<p>See <a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-load-part-iii/">Plotting the Czech Cadastre Land Use with d3: Data Transformation (part <span class="caps">III</span>)</a>.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-extraction-part-i" rel="bookmark" title="Permalink to Plotting the Czech Cadastre Land Use with d3: Data Extraction (part I)">Plotting the Czech Cadastre Land Use with d3: Data Extraction (part&nbsp;I)</a></h1>
    <aside><span>Nov 13, 2016</span>
    <span>    <a href="https://www.zimmi.cz/posts/tag/javascript.html">javascript</a>     <a href="https://www.zimmi.cz/posts/tag/d3.html">d3</a>     <a href="https://www.zimmi.cz/posts/tag/postgresql.html">postgresql</a>     <a href="https://www.zimmi.cz/posts/tag/svg.html">svg</a>    </span>
    <span><a href="https://www.zimmi.cz/posts/category/data.html">data</a></span>
    </aside>
    <p>This post is the first part of the upcoming series summarizing the process of visualizing landuse data with bash, PostgreSQL and d3.js. Read other&nbsp;parts:</p>
<ol>
<li>you&#8217;re reading it&nbsp;now</li>
<li><a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-transformation-part-ii">Plotting the Czech Cadastre Land Use with d3: Data Transformation (part <span class="caps">II</span>)</a></li>
<li><a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-load-part-iii/">Plotting the Czech Cadastre Land Use with d3: Data Transformation (part <span class="caps">III</span>)</a></li>
</ol>
<p><a href="http://cuzk.cz/en">Czech Office for Surveying, Mapping and Cadastre</a> has recently published lot of data via <a href="http://atom.cuzk.cz">Atom feed</a>. There&#8217;s pretty small and a bit boring dataset included, featuring quarterly updated landuse-related values for all 13,091 cadastral&nbsp;areas:</p>
<ul>
<li>absolute number of land lots within given category (arable land, forests,&nbsp;etc.)</li>
<li>absolute area of land lots within given&nbsp;category</li>
</ul>
<p>Data are published as <span class="caps">CSV</span> files linked from the Atom feed. Sadly, they come windows-1250 encoded, using Windows line endings, with trailing semicolons and header rows using&nbsp;diacritics.</p>
<h2><span class="caps">ETL</span>&nbsp;process</h2>
<p>Before the d3 viz can be crafted, it&#8217;s necessary&nbsp;to:</p>
<ol>
<li>extract <span class="caps">CSV</span> data from the URLs provided via the Atom&nbsp;feed</li>
<li>transform those data into a relational database, do some&nbsp;math</li>
<li>load data into a d3.js&nbsp;viz</li>
<li>profit (as&nbsp;usual)</li>
</ol>
<h3>Extract</h3>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># extract.sh -f YYYYMMDD</span>

<span class="k">while</span> <span class="o">[[</span> <span class="nv">$#</span> -gt <span class="m">1</span> <span class="o">]]</span>
<span class="k">do</span>
<span class="nv">key</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>

<span class="k">case</span> <span class="nv">$key</span> in
    -f<span class="p">|</span>--file<span class="o">)</span>
    <span class="nv">FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
    <span class="nb">shift</span> <span class="c1"># past argument</span>
    <span class="p">;;</span>
    *<span class="o">)</span>
        <span class="c1"># unknown option</span>
    <span class="p">;;</span>
<span class="k">esac</span>
<span class="nb">shift</span> <span class="c1"># past argument or value</span>
<span class="k">done</span>

<span class="nv">URL</span><span class="o">=</span>http://services.cuzk.cz/sestavy/UHDP/UHDP-
<span class="nv">CSVFILE</span><span class="o">=</span><span class="nv">$FILE</span>.csv
<span class="nv">CSVUTF8FILE</span><span class="o">=</span><span class="si">${</span><span class="nv">CSVFILE</span><span class="p">%.*</span><span class="si">}</span>.utf.csv
<span class="nv">URL</span><span class="o">+=</span><span class="nv">$CSVFILE</span>

<span class="nb">echo</span> <span class="s2">&quot;downloading </span><span class="nv">$URL</span><span class="s2">&quot;</span>
wget -q <span class="nv">$URL</span> -O <span class="nv">$CSVFILE</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    rm -f <span class="nv">$CSVFILE</span>
    <span class="nb">echo</span> <span class="s2">&quot;download failed&quot;</span>
    <span class="nb">exit</span>
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">&quot;converting to utf-8&quot;</span>
iconv -f WINDOWS-1250 -t UTF-8 <span class="nv">$CSVFILE</span> -o <span class="nv">$CSVUTF8FILE</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="nb">echo</span> <span class="s2">&quot;modifying </span><span class="si">${</span><span class="nv">FILE</span><span class="si">}</span><span class="s2">&quot;</span>
sed -i <span class="s1">&#39;s/^M$//&#39;</span> <span class="nv">$CSVUTF8FILE</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
sed -i <span class="s1">&#39;s/\r$//&#39;</span> <span class="nv">$CSVUTF8FILE</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
sed -i <span class="s1">&#39;s/;*$//g&#39;</span> <span class="nv">$CSVUTF8FILE</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
sed -i <span class="s1">&#39;1d&#39;</span> <span class="nv">$CSVUTF8FILE</span>

<span class="nb">echo</span> <span class="s2">&quot;importing to database&quot;</span>
sed -e <span class="s2">&quot;s/\${DATE}/</span><span class="nv">$FILE</span><span class="s2">/g&quot;</span> extract.sql <span class="p">|</span> psql -qAt --no-psqlrc

rm <span class="nv">$CSVFILE</span> <span class="nv">$CSVUTF8FILE</span>
</pre></div>


<p>This script downloads <span class="caps">CSV</span> file, deals with all the pitfalls mentioned above and, when done, <code>copy</code> command within <code>extract.sql</code> loads the data into a <code>data_YYYYMMDD</code> table. Putting all the files into the one table would have saved me a lot of transformation <span class="caps">SQL</span>, yet it didn&#8217;t feel quite right&nbsp;though.</p>
<h2>Transform</h2>
<p>See <a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-transformation-part-ii">Plotting the Czech Cadastre Land Use with d3: Data Transformation (part <span class="caps">II</span>)</a>.</p>
<h2>Load</h2>
<p>See <a href="https://www.zimmi.cz/posts/2016/plotting-czech-cadastre-land-use-with-d3-data-load-part-iii/">Plotting the Czech Cadastre Land Use with d3: Data Transformation (part <span class="caps">III</span>)</a>.</p>
</article>
<aside id="pagination">
            <a onclick="javascript:_paq.push(['trackEvent', 'Pagination', 'Next page']);" href="https://www.zimmi.cz/posts/tag/javascript2.html">Next page &raquo;</a>
</aside>    </main>
    <footer>
        Written by <a href="//www.zimmi.cz">Michal Zimmermann</a>.
        Proudly powered by <a href="//getpelican.com/">Pelican</a>,
        which takes great advantage of <a href="//python.org">Python</a>.
    </footer>
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-43432739-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-43432739-2');
</script>
</body>
</html>