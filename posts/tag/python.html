<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
        <title>Michal Zimmermann | tag: python</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">
        <link href="http://localhost:8000/atom.xml" type="application/atom+xml" rel="alternate" title="Michal Zimmermann Full Atom Feed" />
        <link href="http://localhost:8000/feed.xml" type="application/rss+xml" rel="alternate" title="Michal Zimmermann Full RSS Feed" />
        <link rel="stylesheet" href="https://www.zimmi.cz/posts/theme/css/style.min.css?6d23b170">
</head>
<body>
    <nav role="navigation">
        <ul>
            <li><a href="https://www.zimmi.cz/posts/categories">Categories</a></li>
            <li><a href="https://www.zimmi.cz/posts/tags">Tags</a></li>
            <li><a href="https://www.zimmi.cz/posts/feed.xml">Subscribe to RSS feed</a></li>
            <li>
                <form class="search" name="x" action="//duckduckgo.com/" target="_blank">
                    <input type="hidden" value="zimmi.cz/posts" name="sites"></input>
                    <input class="search-input" type="search" placeholder="Search" name="q"></input>
                    <input class="button" type="submit" value="Go"></input>
                </form>
            </li>
        </ul>
    </nav>
    <header>
        <h1><a href="/posts">Michal Zimmermann<small>Pieces of knowledge from the world of GIS.</small></a></h1>
    </header>
    <main>
<h2 class="text-center">Articles tagged with python tag</h2>

<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-testing-your-code/" rel="bookmark" title="Permalink to QGIS Plugin Development: Testing Your Code"><span class="caps">QGIS</span> Plugin Development: Testing Your&nbsp;Code</a></h1>
    <aside><span>Nov 30, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/qgis.html">QGIS</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/qgis.html">QGIS</a></span>
    </aside>
    <p>Good news, everyone! The <a href="https://plugins.qgis.org/plugins/AttributeTransfer/">AttributeTransfer</a> plugin has been approved for <a href="https://plugins.qgis.org/plugins/"><span class="caps">QGIS</span> Python Plugins Repository</a>. It&#8217;s available via <span class="caps">QGIS</span> <em>Manage and Install Plugins</em> menu. Feel free to&nbsp;download!</p>
<p>Nevertheless, this post (the last in the series) covers <span class="caps">QGIS</span> plugin testing rather than my personal feelings about the aforementioned&nbsp;success.</p>
<h2>Testing means&nbsp;mocking</h2>
<p>To test a <span class="caps">QGIS</span> plugin you need to simulate the environment it&#8217;s meant to run in. And that environment is obviously <span class="caps">QGIS</span> itself, yet it&#8217;s not feasible to launch <span class="caps">QGIS</span> every time you run a test. Luckily, <a href="https://github.com/zimmicz/qgis-attribute-transfer-plugin/blob/master/tests/utilities.py">there&#8217;s a great <code>QGIS</code> mock</a> that gets you going in no time (it completely slipped my mind where I found that piece of code&nbsp;though).</p>
<h2>Testing means you need&nbsp;data</h2>
<p>Every test is run again and again, which means it has to reset the data being used to its default state. This might be a <span class="caps">PIDA</span> if the test changes the data in an unpredictable&nbsp;manner.</p>
<p>Using <span class="caps">QGIS</span> memory layers <a href="https://github.com/zimmicz/qgis-attribute-transfer-plugin/blob/master/tests/create_dummy_data.py">you can prepare fresh data</a> for each of your tests, effectively putting the whole data manipulation process&nbsp;aside.</p>
<h2>Writing&nbsp;tests</h2>
<p>Each of the AttributeTransfer plugin tests inherits from <code>unittest.TestCase</code>, which comes with several methods you might be familiar with from other languages: <code>setUp()</code> is run before for every test method, while <code>tearDown()</code> is run after each of them. Tests are defined as methods whose names start with the word <code>test</code>.</p>
<p>Each test should call some <code>assertWhatever</code> method that checks whether the test passed or failed. Here&#8217;s an example of such a test covering non-point&nbsp;layers.</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># @Date    : 2017-11-18 18:40:50</span>
<span class="c1"># @Author  : Michal Zimmermann &amp;lt;zimmicz@gmail.com&amp;gt;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sip</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="n">QgsMapLayerRegistry</span><span class="p">,</span> <span class="n">QgsVectorLayer</span><span class="p">,</span> <span class="n">QgsFeature</span><span class="p">,</span> <span class="n">QgsGeometry</span><span class="p">,</span> <span class="n">QgsPoint</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">get_qgis_app</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;/..&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">attribute_transfer</span> <span class="kn">import</span> <span class="n">AttributeTransfer</span>
<span class="kn">from</span> <span class="nn">create_dummy_data</span> <span class="kn">import</span> <span class="n">create_dummy_data_polygon_or_line</span>

<span class="n">sip</span><span class="o">.</span><span class="n">setapi</span><span class="p">(</span><span class="s1">&#39;QtCore&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">sip</span><span class="o">.</span><span class="n">setapi</span><span class="p">(</span><span class="s1">&#39;QString&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">sip</span><span class="o">.</span><span class="n">setapi</span><span class="p">(</span><span class="s1">&#39;QDate&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">sip</span><span class="o">.</span><span class="n">setapi</span><span class="p">(</span><span class="s1">&#39;QDateTime&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">sip</span><span class="o">.</span><span class="n">setapi</span><span class="p">(</span><span class="s1">&#39;QTextStream&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">sip</span><span class="o">.</span><span class="n">setapi</span><span class="p">(</span><span class="s1">&#39;QTime&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">sip</span><span class="o">.</span><span class="n">setapi</span><span class="p">(</span><span class="s1">&#39;QUrl&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">sip</span><span class="o">.</span><span class="n">setapi</span><span class="p">(</span><span class="s1">&#39;QVariant&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">QGIS_APP</span> <span class="o">=</span> <span class="n">get_qgis_app</span><span class="p">()</span>
<span class="n">IFACE</span> <span class="o">=</span> <span class="n">QGIS_APP</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">AttributeTransferTestPolygonOrLine</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_layer</span> <span class="o">=</span> <span class="n">QgsVectorLayer</span><span class="p">(</span>
            <span class="s2">&quot;Polygon?crs=epsg:4326&amp;amp;field=id:integer&amp;amp;field=textAttr:string&amp;amp;field=intAttr:integer&amp;amp;field=decAttr:double&amp;amp;field=dateAttr:date&amp;amp;index=yes&quot;</span><span class="p">,</span> <span class="s2">&quot;source layer&quot;</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_layer</span> <span class="o">=</span> <span class="n">QgsVectorLayer</span><span class="p">(</span>
            <span class="s2">&quot;Linestring?crs=epsg:4326&amp;amp;field=id:integer&amp;amp;index=yes&quot;</span><span class="p">,</span> <span class="s2">&quot;target layer&quot;</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">AttributeTransfer</span><span class="p">(</span><span class="n">IFACE</span><span class="p">)</span>

        <span class="n">registry</span> <span class="o">=</span> <span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="n">registry</span><span class="o">.</span><span class="n">removeAllMapLayers</span><span class="p">()</span>
        <span class="n">registry</span><span class="o">.</span><span class="n">addMapLayers</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">source_layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_layer</span><span class="p">])</span>
        <span class="n">create_dummy_data_polygon_or_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_layer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">initGui</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">vectors</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source_layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_layer</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">editable_vectors</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source_layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_layer</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">dlg</span><span class="o">.</span><span class="n">sourceLayer</span><span class="o">.</span><span class="n">addItems</span><span class="p">([</span><span class="s2">&quot;source layer&quot;</span><span class="p">,</span> <span class="s2">&quot;target layer&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_text_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ATTRIBUTE_NAME</span> <span class="o">=</span> <span class="s2">&quot;textAttr&quot;</span>
        <span class="n">ATTRIBUTE_INDEX</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_test_attr</span><span class="p">(</span><span class="n">ATTRIBUTE_NAME</span><span class="p">,</span> <span class="n">ATTRIBUTE_INDEX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_int_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ATTRIBUTE_NAME</span> <span class="o">=</span> <span class="s2">&quot;intAttr&quot;</span>
        <span class="n">ATTRIBUTE_INDEX</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_test_attr</span><span class="p">(</span><span class="n">ATTRIBUTE_NAME</span><span class="p">,</span> <span class="n">ATTRIBUTE_INDEX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_dec_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ATTRIBUTE_NAME</span> <span class="o">=</span> <span class="s2">&quot;decAttr&quot;</span>
        <span class="n">ATTRIBUTE_INDEX</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_test_attr</span><span class="p">(</span><span class="n">ATTRIBUTE_NAME</span><span class="p">,</span> <span class="n">ATTRIBUTE_INDEX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_date_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ATTRIBUTE_NAME</span> <span class="o">=</span> <span class="s2">&quot;dateAttr&quot;</span>
        <span class="n">ATTRIBUTE_INDEX</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_test_attr</span><span class="p">(</span><span class="n">ATTRIBUTE_NAME</span><span class="p">,</span> <span class="n">ATTRIBUTE_INDEX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_existing_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ATTRIBUTE_NAME</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span>
        <span class="n">ATTRIBUTE_INDEX</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">dlg</span><span class="o">.</span><span class="n">sourceAttribute</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">ATTRIBUTE_INDEX</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">dlg</span><span class="o">.</span><span class="n">targetAttribute</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">ATTRIBUTE_NAME</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">dlg</span><span class="o">.</span><span class="n">sourceAttribute</span><span class="o">.</span><span class="n">currentText</span><span class="p">(),</span> <span class="n">ATTRIBUTE_NAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">transfer</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_test_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_index</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">dlg</span><span class="o">.</span><span class="n">sourceAttribute</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">attr_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">dlg</span><span class="o">.</span><span class="n">targetAttribute</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">dlg</span><span class="o">.</span><span class="n">sourceAttribute</span><span class="o">.</span><span class="n">currentText</span><span class="p">(),</span> <span class="n">attr_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">transfer</span><span class="p">()</span>

        <span class="n">target_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
                         <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_layer</span><span class="o">.</span><span class="n">dataProvider</span><span class="p">()</span><span class="o">.</span><span class="n">fields</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">target_fields</span><span class="p">)</span>

        <span class="n">source_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">()]</span>
        <span class="n">target_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">()]</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">source_features</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="n">attr_name</span><span class="p">),</span> <span class="n">target_features</span><span class="p">[</span>
                             <span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="n">attr_name</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-attributetransfer-plugin/" rel="bookmark" title="Permalink to QGIS Plugin Development: AttributeTransfer Plugin"><span class="caps">QGIS</span> Plugin Development: AttributeTransfer&nbsp;Plugin</a></h1>
    <aside><span>Nov 23, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/qgis.html">QGIS</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/qgis.html">QGIS</a></span>
    </aside>
    <p>This part finally brings <a href="https://github.com/zimmicz/qgis-attribute-transfer-plugin">the whole source code of the <span class="caps">QGIS</span> AttributeTransfer plugin</a>.</p>
<div class="text-center"><img src="/posts/assets/qgis-plugin-development-attribute-transfer-plugin/qgis.gif"/></div>

<p>The plugin itself resides in the <a href="https://github.com/zimmicz/qgis-attribute-transfer-plugin/blob/master/attribute_transfer.py"><code>attribute_transfer.py</code></a> file. When <code>run()</code> method is invoked, the <span class="caps">QT</span> form pops up with combos prefilled with available vector layers that support attribute&nbsp;editing.</p>
<p>Source and target layer combos are mutually exclusive, thus it&#8217;s not possible to transfer the attribute within the same&nbsp;layer.</p>
<p>Coding the plugin, I came across minor issues related mainly to the <code>QgsSpatialIndex</code> implementation. In <a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-finding-nearest-neighbors/">the nearest neighbor analysis part</a> of the series, the <code>QgsSpatialIndex.nearestNeighbor</code> method was mentioned. Yet, as I found out, this method only works with <code>QgsPoint</code> geometries. Those are impossible to get from <code>QgsPolygon</code> or <code>QgsPolyline</code>, though. What can one possibly do, facing such a misfortune? Well&hellip; draw a solution&nbsp;matrix.</p>
<table>
<thead>
<tr>
<th></th>
<th>point</th>
<th>line</th>
<th>polygon</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>point</strong></td>
<td>QgsSpatialIndex.nearestNeighbor</td>
<td>QgsSpatialIndex.nearestNeighbor; layers have to be switched, e.g. source layer = line</td>
<td>QgsSpatialIndex.nearestNeighbor; layers have to be switched, e.g. source layer = polygon</td>
</tr>
<tr>
<td><strong>line</strong></td>
<td>QgsSpatialIndex.nearestNeighbor</td>
<td>QgsSpatialIndex.intersects with QgsGeometry.distance</td>
<td>QgsSpatialIndex.intersects with QgsGeometry.distance</td>
</tr>
<tr>
<td><strong>polygon</strong></td>
<td>QgsSpatialIndex.nearestNeighbor</td>
<td>QgsSpatialIndex.intersects with QgsGeometry.distance</td>
<td>QgsSpatialIndex.intersects with QgsGeometry.distance</td>
</tr>
</tbody>
</table>
<p>Using the spatial index brings one more issue I&#8217;ve come to realize just after implementing the special comparison workflows for different geometry types. There&#8217;s a chance of finding the nearest feature using the bounding box that&#8217;s actually <em>not</em> the nearest feature. In that case, I chose to find the most distant vertex of such a feature and use it to construct the rectangle around the target feature. If there are any source features in such a rectangle, it&#8217;s very likely one of them is the <em>real</em> nearest&nbsp;feature.</p>
<div class="text-center"><img src="/posts/assets/qgis-plugin-development-attribute-transfer-plugin/qgis.png"/></div>

<p>Right now, I&#8217;m working on <a href="https://github.com/zimmicz/qgis-attribute-transfer-plugin/issues/3">finding the nearest feature even if no bounding box intersection is found</a>. Meanwhile, <a href="https://github.com/zimmicz/qgis-attribute-transfer-plugin/issues/2">the plugin is being reviewed</a> to be featured in <a href="https://plugins.qgis.org"><span class="caps">QGIS</span> Plugins repository</a>. Fingers&nbsp;crossed.</p>
<p>I thought this was going to be the last part of the series. But how could one possibly claim the coding project done without writing <em>tests</em>? Stay tuned for the next&nbsp;episode.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-creating-gui-with-qt-designer/" rel="bookmark" title="Permalink to QGIS Plugin Development: Creating GUI with Qt Designer"><span class="caps">QGIS</span> Plugin Development: Creating <span class="caps">GUI</span> with Qt&nbsp;Designer</a></h1>
    <aside><span>Nov 16, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/qgis.html">QGIS</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/qgis.html">QGIS</a></span>
    </aside>
    <p>After fiddling with <a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-using-python-console/"><span class="caps">QGIS</span> Python console</a> and implementing <a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-finding-nearest-neighbors/">nearest neighbor analysis</a>, I&#8217;m going to create a very simple <span class="caps">GUI</span> for the plugin at&nbsp;last.</p>
<p>While <span class="caps">QGIS</span> <span class="caps">API</span> docs took me few hours to grasp, the PyQGIS ecosystem knocked my socks off. Here comes the list of tools you should incorporate into your development process as soon as&nbsp;possible.</p>
<h2>Plugin&nbsp;Builder</h2>
<p>The <a href="https://plugins.qgis.org/plugins/pluginbuilder/"><span class="caps">QGIS</span> Plugin Builder</a> is a plugin created to create&hellip; well, other plugins. It gets you going in minutes and lets you code instead of setting up things you don&#8217;t want to be setting up. A definite must-have. Note you should put the plugin inside the <span class="caps">QGIS</span> plugins folder (defaults to ~/.qgis2/python/plugins) in&nbsp;Linux.</p>
<div class="text-center"><img src="/posts/assets/qgis-plugin-development-creating-gui-with-qt-designer/qgis.gif"/></div>

<p>Remember to run <code>pyrcc4 -o resources.py resources.qrc</code> inside your plugin folder before you add it to <span class="caps">QGIS</span>.</p>
<h2>Plugin&nbsp;Reloader</h2>
<p>The <a href="https://plugins.qgis.org/plugins/plugin_reloader/"><span class="caps">QGIS</span> Plugin Reloader</a> is a plugin (possibly created with <span class="caps">QGIS</span> Plugin Builder) that lets you live reload your plugin while you code. No <span class="caps">QGIS</span> restarts needed. A definite&nbsp;must-have.</p>
<h2>Qt&nbsp;Designer</h2>
<p><a href="https://www.qt.io/qt-features-libraries-apis-tools-and-ide/">Qt Designer</a> comes with <code>qt4-designer</code> package in Ubuntu. It is tailored to design and build GUIs from Qt components that can be used within <span class="caps">QGIS</span>. Its drag&amp;drop interface lets you prototype&nbsp;quickly.</p>
<p>Thanks to the Plugin Builder you can load the <code>attribute_transfer_dialog_base.ui</code> file straight into the Qt Designer and adjust it to your&nbsp;needs.</p>
<div class="text-center"><img src="/posts/assets/qgis-plugin-development-creating-gui-with-qt-designer/qt.gif"/></div>

<p>It doesn&#8217;t take much, just one <code>QLineEdit</code> and a few <code>QComboBox</code> widgets. Those will be available in the <code>attribute_transfer.py</code> file as properties of the <code>AttributeTransferDialog</code> class.</p>
<p>The widget name can be customized in the right sidebar and I advise you to do so. I chose the&nbsp;following:</p>
<div class="text-center"><img src="/posts/assets/qgis-plugin-development-creating-gui-with-qt-designer/qt.png"/></div>

<p>Once loaded with Plugins -&gt; Manage and Install Plugins -&gt; AttributeTransfer, the plugin is available right from the toolbar or Vector menu. It is missing the business logic completely, but I have this covered in <a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-finding-nearest-neighbors/">the previous part</a>.</p>
<p>All that is to be done is to bind those two parts&nbsp;together.</p>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-finding-nearest-neighbors/" rel="bookmark" title="Permalink to QGIS Plugin Development: Finding Nearest Neighbors"><span class="caps">QGIS</span> Plugin Development: Finding Nearest&nbsp;Neighbors</a></h1>
    <aside><span>Nov 9, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/qgis.html">QGIS</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/qgis.html">QGIS</a></span>
    </aside>
    <p>I described basics of vector layers manipulation in <a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-using-python-console/">the previous part</a> of the series. With my goal in mind (fully functional custom plugin capable of writing an attribute value from a source layer to a target layer based on a feature distance), I&#8217;d like to discuss <strong>spatial indexing</strong> and <strong>nearest neighbor analysis</strong>.</p>
<div class="text-center"><img src="/posts/assets/qgis-plugin-development-finding-nearest-neighbors/qgis.png"/></div>

<p>The picture above illustrates the task that can be solved solely by using <span class="caps">QGIS</span> <span class="caps">API</span>. Imagine you&#8217;re given a source layer with an attribute filled with values. You&#8217;re given a target layer as well, sadly though, the values in this layer are missing (<em>not so rare in the <span class="caps">GIS</span> world, right?</em>). Yet you know that the missing attribute value of each feature in the target layer can be filled by the value of its nearest neighbor from the source layer. How do you do&nbsp;that?</p>
<h2>Generating dummy&nbsp;data</h2>
<p>Let&#8217;s create two memory data sets with id and value attributes. Both of them will have ten&nbsp;features.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="n">QgsMapLayerRegistry</span><span class="p">,</span> <span class="n">QgsVectorLayer</span><span class="p">,</span> <span class="n">QgsFeature</span><span class="p">,</span> <span class="n">QgsGeometry</span><span class="p">,</span> <span class="n">QgsPoint</span><span class="p">,</span> <span class="n">QgsSpatialIndex</span>
<span class="kn">from</span> <span class="nn">qgis.utils</span> <span class="kn">import</span> <span class="n">iface</span>

<span class="n">source_layer</span> <span class="o">=</span> <span class="n">QgsVectorLayer</span><span class="p">(</span><span class="s2">&quot;point?crs=epsg:4326&amp;amp;field=id:integer&amp;amp;field=value:integer&quot;</span><span class="p">,</span> <span class="s2">&quot;Source layer&quot;</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">)</span>
<span class="n">target_layer</span> <span class="o">=</span> <span class="n">QgsVectorLayer</span><span class="p">(</span><span class="s2">&quot;point?crs=epsg:4326&amp;amp;field=id:integer&amp;amp;field=value:integer&quot;</span><span class="p">,</span> <span class="s2">&quot;Target layer&quot;</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_dummy_data</span><span class="p">():</span>

    <span class="n">source_layer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>
    <span class="n">target_layer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>

    <span class="n">feature</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">(</span><span class="n">source_layer</span><span class="o">.</span><span class="n">pendingFields</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">QgsPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">source_layer</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

    <span class="n">feature</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">(</span><span class="n">source_layer</span><span class="o">.</span><span class="n">pendingFields</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">QgsGeometry</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">QgsPoint</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">target_layer</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

    <span class="n">source_layer</span><span class="o">.</span><span class="n">commitChanges</span><span class="p">()</span>
    <span class="n">target_layer</span><span class="o">.</span><span class="n">commitChanges</span><span class="p">()</span>

    <span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="n">source_layer</span><span class="p">)</span>
    <span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="n">target_layer</span><span class="p">)</span>

<span class="n">create_dummy_data</span><span class="p">()</span>
</pre></div>


<h2>Writing values from the nearest&nbsp;neighbor</h2>
<p>The actual nearest neighbor analysis can be done in ten lines of code! First, the <code>qgis.core.QgsSpatialIndex</code> is built from all the <code>source_layer</code> features. Then, you iterate over the <code>target_layer</code> features and for each of them, gets only one (<code>nearestNeighbor(f.geometry().asPoint(), 1)[0]</code>) nearest neighbor. At last, you just write the nearest neighbor&#8217;s attribute value to the target layer and commit changes. Just use the following code with the code&nbsp;above.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">write_values_from_nn</span><span class="p">():</span>
    <span class="n">source_layer_index</span> <span class="o">=</span> <span class="n">QgsSpatialIndex</span><span class="p">(</span><span class="n">source_layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">())</span>
    <span class="n">source_layer_features</span> <span class="o">=</span> <span class="p">{</span><span class="n">feature</span><span class="o">.</span><span class="n">id</span><span class="p">():</span> <span class="n">feature</span> <span class="k">for</span> <span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="ow">in</span> <span class="n">source_layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">()}</span>
    <span class="n">target_layer_features</span> <span class="o">=</span> <span class="n">target_layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">()</span>

    <span class="n">target_layer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">target_layer_features</span><span class="p">:</span>
        <span class="n">nearest</span> <span class="o">=</span> <span class="n">source_layer_index</span><span class="o">.</span><span class="n">nearestNeighbor</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">asPoint</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">source_layer_features</span><span class="p">[</span><span class="n">nearest</span><span class="p">]</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
        <span class="n">target_layer</span><span class="o">.</span><span class="n">changeAttributeValue</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="n">target_layer</span><span class="o">.</span><span class="n">commitChanges</span><span class="p">()</span>

<span class="n">write_values_from_nn</span><span class="p">()</span>
</pre></div>


<h2>Missing pieces or what&#8217;s&nbsp;next</h2>
<p>I&#8217;m one step closer to my goal. What&#8217;s&nbsp;missing?</p>
<ul>
<li>capabilities checks: does the target layer support edits? Check the layer data provider capabilities to find&nbsp;out.</li>
<li>user logging: notices, warnings or errors are completely missing. It will be great to have them shown inside <code>qgis.gui.QgsMessageBar</code>.</li>
<li>custom attributes: this version expects both layers to have the same attribute with the same data&nbsp;type.</li>
<li><span class="caps">GUI</span>: a very simple PyQt widget will turn this console-based script into a custom plugin. That&#8217;s what&#8217;s going to be&nbsp;next.</li>
</ul>
</article>
<article>
    <h1><a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-using-python-console/" rel="bookmark" title="Permalink to QGIS Plugin Development: Using Python Console"><span class="caps">QGIS</span> Plugin Development: Using Python&nbsp;Console</a></h1>
    <aside><span>Nov 2, 2017</span>
    <span>    <a class="tag-url" href="https://www.zimmi.cz/posts/tag/python.html">python</a>     <a class="tag-url" href="https://www.zimmi.cz/posts/tag/qgis.html">QGIS</a>    </span>
    <span><a class="category-url" href="https://www.zimmi.cz/posts/category/qgis.html">QGIS</a></span>
    </aside>
    <p>As mentioned in <a href="https://www.zimmi.cz/posts/2017/qgis-plugin-development-getting-started/">previous part</a> of the series, the <span class="caps">QGIS</span> Python console is an entry point to <span class="caps">GIS</span> workflow automation within <span class="caps">QGIS</span>. Remember there&#8217;s an <code>iface</code> object representing <code>qgis.gui.QgisInterface</code> instance within the console that gives you access to the whole <span class="caps">QGIS</span> <span class="caps">GUI</span>. Let&#8217;s see what we can do inside the&nbsp;console.</p>
<h2>Loading vector layers&nbsp;folder</h2>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="n">QgsMapLayerRegistry</span><span class="p">,</span> <span class="n">QgsVectorLayer</span>

<span class="k">def</span> <span class="nf">load_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
    <span class="n">VALID_EXTENSIONS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.geojson&#39;</span><span class="p">,</span> <span class="s1">&#39;.gpkg&#39;</span><span class="p">,</span> <span class="s1">&#39;.shp&#39;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;{}/*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">VALID_EXTENSIONS</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">QgsVectorLayer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;ogr&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">layer</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="n">iface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushCritical</span><span class="p">(</span><span class="s2">&quot;Failed to load:&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

<span class="n">load_folder</span><span class="p">(</span><span class="s2">&quot;path/to/your/vector/files/folder&quot;</span><span class="p">)</span>
</pre></div>


<ul>
<li><code>QgsMapLayerRegistry</code> represents <em>Layers Panel</em> as present in the <span class="caps">QGIS</span> <span class="caps">GUI</span></li>
<li><code>iface.messageBar()</code> returns the message bar of the main app and lets you notify the user of what&#8217;s going on under the&nbsp;hood</li>
<li><code>QgsVectorLayer</code> represents a vector layer with its underlying vector data&nbsp;sets</li>
</ul>
<h2>Editing active layer attribute&nbsp;table</h2>
<p>The following code demonstrates the possibility to edit vector layer attribute table via&nbsp;console.</p>
<ul>
<li>Any attribute to be written has to come in form of a <code>qgis.core.QgsField</code> - this is more or less an encapsulation of an attribute name and its type (<code>PyQt4.QtCore.QVariant</code> to be&nbsp;precise)</li>
<li>The underlying data provider has to be capable of attribute addition (<code>caps &amp; QgsVectorDataProvider.AddAttributes</code>)</li>
<li><code>QgsVectorLayer.addAttribute</code> method returns boolean rather than throwing an&nbsp;exception</li>
</ul>
<!-- -->

<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="n">QgsField</span>
<span class="kn">from</span> <span class="nn">qgis.gui</span> <span class="kn">import</span> <span class="n">QgsMessageBar</span>
<span class="kn">from</span> <span class="nn">PyQt4.QtCore</span> <span class="kn">import</span> <span class="n">QVariant</span>


<span class="k">def</span> <span class="nf">edit_active_layer</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_type</span><span class="p">):</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">iface</span><span class="o">.</span><span class="n">activeLayer</span><span class="p">()</span>
    <span class="n">caps</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">dataProvider</span><span class="p">()</span><span class="o">.</span><span class="n">capabilities</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">caps</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">QgsVectorDataProvider</span><span class="o">.</span><span class="n">AddAttributes</span><span class="p">:</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">QgsField</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_type</span><span class="p">)):</span>
            <span class="n">iface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span><span class="s2">&quot;Attribute {0} was successfully added to the active layer.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_name</span><span class="p">),</span> <span class="n">QgsMessageBar</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">)</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">commitChanges</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span><span class="s2">&quot;Attribute {0} was not added. Does it already exist?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_name</span><span class="p">),</span> <span class="n">QgsMessageBar</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">rollBack</span><span class="p">()</span>

<span class="n">edit_active_layer</span><span class="p">(</span><span class="s2">&quot;new_string_attribute&quot;</span><span class="p">,</span> <span class="n">QVariant</span><span class="o">.</span><span class="n">String</span><span class="p">)</span>
</pre></div>


<p>The whole series aims to present a plugin capable of writing a new attribute and its value to an existing layer. Thus, this code might come handy in the&nbsp;future.</p>
<h2>Creating a new vector&nbsp;layer</h2>
<p>It&#8217;s possible to create a whole new vector layer with <span class="caps">QGIS</span> Python console. I present a very simple <code>create_new_layer</code> function, yet I hope you can imagine the ways it can be&nbsp;tweaked.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qgis.core</span> <span class="kn">import</span> <span class="n">QgsField</span><span class="p">,</span> <span class="n">QgsFields</span><span class="p">,</span> <span class="n">QgsVectorLayer</span><span class="p">,</span> <span class="n">QgsFeature</span><span class="p">,</span> <span class="n">QgsGeometry</span><span class="p">,</span> <span class="n">QgsPoint</span>
<span class="kn">from</span> <span class="nn">PyQt4.QtCore</span> <span class="kn">import</span> <span class="n">QVariant</span>

<span class="k">def</span> <span class="nf">create_new_layer</span><span class="p">():</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;/path/to/your/vector/file.gpkg&quot;</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="n">QgsFields</span><span class="p">()</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">QgsField</span><span class="p">(</span><span class="s2">&quot;attr1&quot;</span><span class="p">,</span> <span class="n">QVariant</span><span class="o">.</span><span class="n">String</span><span class="p">))</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">QgsField</span><span class="p">(</span><span class="s2">&quot;attr2&quot;</span><span class="p">,</span> <span class="n">QVariant</span><span class="o">.</span><span class="n">Int</span><span class="p">))</span>

    <span class="nb">file</span> <span class="o">=</span> <span class="n">QgsVectorFileWriter</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span>
        <span class="s2">&quot;UTF8&quot;</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">,</span>
        <span class="n">QGis</span><span class="o">.</span><span class="n">WKBPoint</span><span class="p">,</span>
        <span class="n">QgsCoordinateReferenceSystem</span><span class="p">(</span><span class="mi">4326</span><span class="p">),</span>
        <span class="s2">&quot;GPKG&quot;</span>
    <span class="p">)</span>

    <span class="n">layer</span> <span class="o">=</span> <span class="n">QgsVectorLayer</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;ogr&quot;</span><span class="p">)</span>
    <span class="n">QgsMapLayerRegistry</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">addMapLayer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">layer</span><span class="o">.</span><span class="n">dataProvider</span><span class="p">()</span><span class="o">.</span><span class="n">capabilities</span><span class="p">()</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">QgsVectorDataProvider</span><span class="o">.</span><span class="n">AddAttributes</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">feature</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">pendingFields</span><span class="p">())</span>
    <span class="n">feature</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">QgsGeometry</span><span class="p">()</span><span class="o">.</span><span class="n">fromPoint</span><span class="p">(</span><span class="n">QgsPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="n">feature</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s2">&quot;attr1&quot;</span><span class="p">,</span> <span class="s2">&quot;attr1&quot;</span><span class="p">)</span>
    <span class="n">feature</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s2">&quot;attr2&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">layer</span><span class="o">.</span><span class="n">startEditing</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">commitChanges</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">rollBack</span><span class="p">()</span>
        <span class="n">iface</span><span class="o">.</span><span class="n">messageBar</span><span class="p">()</span><span class="o">.</span><span class="n">pushMessage</span><span class="p">(</span><span class="s2">&quot;Feature addition failed.&quot;</span><span class="p">,</span> <span class="n">QgsMessageBar</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>

<span class="n">create_new_layer</span><span class="p">()</span>
</pre></div>


<p>Those were just few examples of what can be done with <span class="caps">QGIS</span> <span class="caps">API</span> and Python console. Next time, I&#8217;d like to focus on spatial joins inside <span class="caps">QGIS</span> - another step to the final&nbsp;plugin.</p>
</article>
<aside id="pagination">
            <a href="https://www.zimmi.cz/posts/tag/python2.html">Next page &raquo;</a>
</aside>    </main>
    <footer>
        Written by <a href="//www.zimmi.cz">Michal Zimmermann</a>.
        Proudly powered by <a href="//getpelican.com/">Pelican</a>,
        which takes great advantage of <a href="//python.org">Python</a>.
    </footer>
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-43432739-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-43432739-2');
</script>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NW8R37N');</script>
<!-- End Google Tag Manager -->
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NW8R37N"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<script src="https://www.zimmi.cz/posts/theme/js/echo.min.js"></script>
<script>
echo.init({
  offset: 200,
  throttle: 250,
  unload: false
});
</script>
</body>
</html>